---
layout: post
title: "游戏服务器工程实践三：分服分区游戏的架构与性能优化实战"
date: 2024-05-02
last_modified_at: 2024-05-02
categories: [游戏后端]
tags: [gameserver]
---

* 目录  
{:toc}
<br/>


全区全服和分区分服这两大类游戏的服务器我都开发过，宏观架构上，分区分服要简单得多，需要水平扩容的地方不多。   

分区分服游戏范指那种登录注册后，有很多个区服可以选择，选择其中一个之后才能进入游戏的，并且各个区服的角色数据是不互通的（转服、合服、跨服在本质上也都是数据不互通的）。基本上所有的 MMO 都是分区分服的游戏，同一个区服的所有玩家在同一个世界中游戏；也有副本玩法，副本玩法就相当于在一个临时创建的小世界里面 n 个人共同游戏。   

分区分服类型的游戏，其核心挑战是战斗逻辑、网络同步，但宏观架构也至关重要，这关系到：1、能不能撑得住上线后的疯狂导量；2、出问题之后能否快速定位。  

我参与过一款 MMOARPG 游戏的研发，实际上我是中途加入的。我加入的时候，它已经开始做导量测试了，虽然架构上看起来问题不大，都是经典的样子，但是微观上看，各种问题，部署上有问题，开发上也有问题。  

结果就是每次导量的时候，要么用户卡在 sdk 登录这一块，要么就是进得来，卡死在登录区服那里，好不容易进入区服了，当区服 500 人同时在线的时候，就特别卡了。  

并且还有一个更糟糕的事，200 人同服的时候，gamesvr 回写数据库的延迟就高达 1 个小时，而用户每次登录都是从 db 取数据的，所以用户退出并在 1 个小时内重新登录的话，就相当于回档了。  

还有另外的问题，gamesvr 虽然有写 log，但都没用起来的，直到有用户报故障的时候，再去扒日志出来看，

本文将主要介绍分区分服类型游戏的常规架构，以及如何保证它的高可用&容灾。在具体的部署上，也会提供自建和公有云两种方案。另外，会写一写过往的一些优化经验，包括 skynet 相关的优化，战斗场景的消息广播的优化，cpu 消耗的优化。  

---

# 1. 总体架构

## 1.1 架构图

以下是一个实际可用的服务器架构：      

<br/>
<div align="center">
<img src="https://antsmallant-blog-1251470010.cos.ap-guangzhou.myqcloud.com/media/blog/gamesvr-multi-zone-architecture.drawio.png"/>
</div>
<center>图1：分区分服游戏服务器总体架构</center>
<br/>

---

## 1.2 工作过程

以 “玩家登录并进入选中的区服” 为场景，简单说明一下工作过程:   

<br/>
<div align="center">
<img src="https://antsmallant-blog-1251470010.cos.ap-guangzhou.myqcloud.com/media/blog/gamesvr-multi-zone-cli-join-battle-seq.png"/>
</div>
<center>图2：玩家登录并进入选中的区服</center>
<br/>

用文字描述就是：  

1、客户端通过 sdksvr 完成 sdk 登录授权，成功获得一个 sdk token；    
2、客户端通过 sdksvr 获取区服列表；   
3、客户端选中一个区服请求进入，sdksvr 向该区服的 intfsvr（接口服务器）发起 “创角或登录” 请求，intfsvr 响应并返回一个 game token；  
4、客户端使用 game token 连接 gamesvr；   

---

# 2. 架构说明

以上架构图里展示的，需要支持水平扩容的就是 sdksvr 以及它对应的 PlatDB，这是平台级别的，所有的用户都先经过这里，再进入各自的区服，所以高峰的时候负载也特别重的，与全区全服类型的游戏一样。  

下面具体讲下架构的各个组成部分，包括它们的主要作用，以及如何做到水平扩容、高可用、容灾。    

---

## 2.1 网络负载层

这一层主要是为游戏服务层的 sdksvr 集群提供负载均衡的功能。  

|集群|功能|自建方案|公有云方案|
|:--|:--|:--|:--|
|nginx集群|为sdksvr提供7层（http）负载均衡|dns+nginx集群|LB组件的7层LB功能，比如腾讯云的CLB，阿里云的SLB，华为云的ELB|

<br/>

说明：   

* 自建方案，主要是运维的活，采用常规的 高可用 + 容灾方案 即可；    
* 自建方案，如果并发连接数特别夸张，需要考虑采用 F5 之类的硬件；  
* 公有云方便很多：弹性更大，上限更高，扩容简单，更稳定，费用可能更低；    

---

## 2.2 游戏服务器层 

### 2.2.1 各服务器的作用

|服务器|作用|
|:--|:--|
|sdksvr|为玩家提供登录、注册、充值、版本更新、停服公告等功能；为外部厂商提供充值回调、推广回调等功能|
|managesvr|为运营人员提供后台管理功能，比如发公告，开新服，合服等等；为运营人员提供统计数据查看功能|
|intfsvr|区服中的接口服务器（interface server），一般实现为 http server，暴露区服的接口给 sdksvr 和 managesvr，比如创角，修改数据等|
|gamesvr|区服中的游戏服务器，提供所有的游戏功能，有时候实现上不止一个进程，但至少有一个是面向玩家连接的|

---

### 2.2.2 各服务器的特性

|服务器|面向|通讯协议|水平扩容|负载均衡|高可用|容灾|
|:--|:--|:--|:--|:--|:--|:--|
|sdksvr|玩家&外部厂商|http|支持，无状态web服务器|支持，由前置的的nginx集群提供负载均衡|支持，冗余部署即可|支持，无状态的，宕机不丢数据|
|managesvr|运营人员|http|支持，无状态web服务器|支持，但没必要，若需要可部署前置的nginx集群提供负载均衡|支持，冗余部署即可|支持，无状态的，宕机不丢数据|
|intfsvr|其他服务器|http|支持，无状态web服务器，但不需要|支持，但不需要|支持，但不需要|支持，无状态的，宕机不丢数据|
|gamesvr|玩家| (udp or tcp) + protobuf + 长连接|不支持|不支持|不支持|不支持，有状态的，cache了战斗状态，宕机会丢失整个场景数据|

---

### 2.2.3 sdksvr 实现细节

sdksvr 的作用上面表格已经讲了，它的功能并不复杂，就是普通的 web server，用熟悉的 web 框架实现就行，php 或 java 的都 ok。  

但是在导量高峰的时候，sdksvr 集群的压力会特别特别巨大，部署上一定要做到水平扩容、高可用、容灾。  

下面列一些要点。  

**区服列表的cache**  

区服列表是一个高频获取的操作，应该把它放到 redis 或 memcache 中缓存起来。  

**sdk token 的 cache**  

sdk 登录成功后，可以生成 sdk token 并放入 redis 或 memcache 中缓存起来，并设定 expire time。  



---

### 2.2.4 gamesvr 实现细节

**tcp or udp**   

延迟敏感型的游戏，应该使用 udp，找一个靠谱的 rudp 实现即可，比如 kcp，可以做到 “以10%-20%带宽浪费的代价换取了比 TCP快30%-40%的传输速度” [1]。  

对于延迟不敏感的，用 udp 或 tcp 都关系不大。  

**容灾**  

gamesvr 是有状态的服务器，并且通常来说，分服分区游戏的世界状态规模太大了，且延迟要求高，是不可能把状态 cache 到内存数据库的，所以宕机肯定就是无法无缝恢复正常的，所有玩家都得重新进入游戏。  

---

## 2.3 数据层



---

# 参考

[1] skywind3000. kcp.  Available at https://github.com/skywind3000/kcp.   