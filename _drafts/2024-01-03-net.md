---
layout: post
title: "关于网络"
date: 2024-01-03
last_modified_at: 2024-01-03
categories: [network]
tags: [network]
---

* 目录  
{:toc}
<br/>

作为后端开发，特别是网游后端开发，需要频繁的跟网络打交道，写这篇文章记录一些对于网络的理解，问题诊断的思路，常用的一些工具。  

---

## tcp
日常开发中，连网络库都很少需要自己去调用，都被封装到各种框架中了，更不会裸调网络 api 去 connect、listen。但偏偏在面试中，99% 的概率会被问到，tcp 的头部结构是什么样的&各个字段有什么作用，tcp 为什么要三次握手建立连接，tcp 为什么要四次握手释放连接。  

但实际上，tcp 这些问题如果不出现在八股文，它们本身其实还挺有趣的：）   

另外，

#### tcp 容量
单个服务器可以支撑多少并发连接？经常听到 c10k，其实只要性能足够，要 c100k, c1000k, c10000k ... 都没有问题。  

因为每个 tcp 连接是四元组 (source_ip, source_port, target_ip, target_port), 即使服务端这侧的两个值 (target_ip, target_port) 是固定的，那客户端侧 (source_ip, source_port) 的组合也几乎是无限的，在 ipv4 下，理论上限是 2^32 * 65535，即 2 的 48 次方，在 ipv6 下，就更夸张了。    

不过，上面的计算只是为了说明理论上服务器可以支持超大的 tcp 连接数。实际中，一个服务器能建立的连接数，取决于自身的配置，主要就是操作系统和内存。比如在 linux 下，每一对 tcp 连接都要消耗一些内存空间。     


#### tcp 建立连接
tcp 为什么需要3次握手才能建立连接呢？为什么刚好 3 次就够了呢？  

![tcp-head](https://blog.antsmallant.top/media/blog/2024-01-03-network/tcp-head.png)
<center>图1：tcp包头 [1]</center>

这个跟 tcp 的目标有关，tcp 是一个保证消息包可靠有序到达的协议，在设计上为了达到这个目标，在包头加了两个字段，一个叫**序列号码**，另一个叫**确认号码**，通过这一对数字来保证可靠有序的特性。A给B发2个消息，第一个消息50个字节长，第二个消息100个字节长，假设初始序列号是 0，那么 


#### tcp 释放连接


#### tcp 常用工具



#### tcp 问题诊断


#### tcp 和 udp 可以监听同一个端口吗？
可以！因为 ip 包头有个 8 bit 长的 protocol 字段，可以区分更上层的协议。其中 udp 的值是 ，tcp 的值是 6。在这里 （ https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers ） 还可以看到很多其他的看都没看过的其他协议，有上百个。  

![ipv4-head](https://blog.antsmallant.top/media/blog/2024-01-03-network/ipv4-head.png)
<center>图2：ipv4包头 [2]</center>

---

## UDP

#### KCP
游戏里面经常用到 kcp，下面讲讲它的性能以及工作原理。  

它是一种可靠 UDP 实现，

---

## 参考
[1] wikipedia. Transmission_Control_Protocol ( https://en.wikipedia.org/wiki/Transmission_Control_Protocol ).    
[2] wikipedia. Internet_Protocol_version_4 ( https://en.wikipedia.org/wiki/Internet_Protocol_version_4 ).  