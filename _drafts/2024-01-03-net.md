---
layout: post
title: "关于网络"
date: 2024-01-03
last_modified_at: 2024-01-03
categories: [network]
tags: [network]
---

* 目录  
{:toc}
<br/>

作为后端开发，特别是网游后端开发，需要频繁的跟网络打交道，写这篇文章记录一些我对于网络的理解。   



## tcp
日常开发中，连网络库都很少需要自己去调用，都被封装到各种框架中了，更不会裸调网络 api 去 connect、listen。但偏偏在面试中，99% 的概率会被问到，tcp 的头部结构，tcp 为什么要三次握手建立连接，tcp 为什么要四次握手释放连接。  

但实际上，tcp 这些问题本身其实还挺有趣的。  

#### tcp 容量
单个服务器可以支撑多少并发连接？经常听到 c10k，其实只要性能足够，要 c100k, c1000k, c10000k ... 都没有问题。  

因为每个 tcp 连接是四元组，即 source_ip, source_port, target_ip, target_port, 假设服务端这侧的两个值 (target_ip, target_port) 是固定的，那客户端的 source_ip+source_port 的组合几乎是无限的，在 ipv4 下，它的理论上限是 2^32 * 65535，即 2 的 48 次方，在 ipv6 下，就更多得多了。  

不过，上面都是理论值，一个服务器能建立的连接数，还取决于自身的配置，主要就是内存，比如在 linux 下，每一对 tcp 连接都要消耗一些内存空间，


#### tcp 建立连接
tcp 为什么需要3次握手才能建立连接呢？为什么刚好 3 次就够了呢？  

这个跟 tcp 的目标有关，tcp 是一个保证消息包可靠有序到达的协议，在设计上为了达到这个目标，在包头加了两个字段，一个叫**序列号**，另一个叫**确认号**，通过这一对数字来保证可靠有序的特性。A给B发消息， 

![tcp-head](https://blog.antsmallant.top/media/blog/2024-01-03-network/tcp-head.png)
<center>图1：tcp包头</center>


#### tcp 释放连接



## UDP

#### KCP
游戏里面经常用到 kcp，下面讲讲它的性能以及工作原理。  

它是一种可靠 UDP 实现，

