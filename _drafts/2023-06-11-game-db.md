---
layout: post
title: "游戏开发之数据库常识"
date: 2023-06-11
last_modified_at: 2023-06-11
categories: [游戏开发]
tags: [game, db]
---

* 目录  
{:toc}
<br/>

数据库在游戏后端开发中，并不是一个特别重要的事情，但是如果缺乏基本的常识，将导致灾难性的后果。所以，本文将写一写游戏开发中需要知道的数据库常识。  

游戏行业，用得多的数据库无非就这几种：mysql, mongodb, redis。恰好这几种都用过，可以讲一讲。  

从更大的角度讲就是存储了，还包括 etcd，运行日志，流水日志等等，但本文不打算外延，到时再另写一篇讲一讲广义上的存储。日志类存储很值得讲一讲，因为日志数据非常重要，需要规划好怎么存储，想好怎么利用。  

---

# 介绍

---

## mysql

mysql 可能是用得最多的吧，无论是分区分服游戏，或是全区全服游戏，都能使用。   

分区分服的游戏，用 mysql 完全是够的，一般是一个服对应一个db，而一个服活跃的用户一般不会很多，最高同时在线通常是几百上千人，也有比较厉害的所谓万人同服，问题也不大。  

实际部署的时候有一些选择，比如   
* 部署一个 mysql 进程，只服务于本机上开的各个区服，这种情况下假定一个物理机上会开多组区服，并且相对固定；
* N 个物理机部署一个 mysql 进程，服务多个物理机上运行的多个区服；


全区全服的游戏，用 mysql 就需要一些技巧以及规范了，否则会遇到比较严重的容量问题。这种情况下，同时在线人数可多可少，好的游戏几百万人，上千万人同时在线都很正常，我做过的一款上线的游戏，最高在线有30多万人，这时 db 的压力已经是挺大的了。  

要注意一些什么问题呢？下面列一列。  

### 引擎

使用 innodb 应该是一个共识了吧，绝大部分情况下都应该使用 innodb，因为它支持事务，支持行级锁。innodb 在故障后通常可以自动恢复正常，不会有文件损坏，因为它的 redo log 确保了事务的持久性，undo log 确保了事务的原子性，总之，支持事务的引擎会有故障恢复能力（在硬盘没有损坏的前提下）。而像 myisam 这样的不支持事务的引擎，在崩溃的时候，容易丢数据，并且大部分情况下需要手动修复数据。  

简单介绍一下 innodb，它默认是使用 B+ 树作为索引，为何使用 B+ 树呢？很多文章都要论述到，通常就是拿 B-树 跟 B+ 树作比较。  

首先一个前提，要选用一种硬盘友好型的算法，B-树、B+树都是硬盘友好型，但其中 B+ 树更胜一筹，它规定只有叶子节点能存数据，那么非叶节点可以存更多的键，所以 B+ 树的高度会更矮，读写性能也就更高。  

其次，B+ 树适合做范围搜索，B+ 树最底层的叶子节点有指针相连，可以在指定的范围内按索引顺序遍历数据。  

![Bplustree](https://blog.antsmallant.top/media/blog/2023-06-11-game-db/Bplustree.png)  
<center>图1：B+树[1]</center>

### 索引

索引永远是最重要的问题，不能多，也不能少，刚刚好，性能就最好。否则动不动在那里扫描一张大表，mysql 工作起来好难受的，除非有好几个 T 的内存给你折腾。即使有这么多内存，效率也是不高。  

索引需要记住的原则主要包括：  
1、

下面讲一讲什么是好的实践。  

首先，云数据库是不错的选择，现在的云数据库可以方便的做主从热备、故障切换、异地灾备，还有非常完善的性能监控、性能告警。阿某云还有更高级的特性：SQL洞察，这个功能可以从很多维度查看 db 的性能消耗，比如不走索引的 SQL、特定 SQL 的总时间占据，非常合适作为数据库优化的参考，也适合每次新版本上线后发现 SQL 性能问题。  



---

## mongodb

mongodb 用得并不多，一开始使用它是贪图方便，在多人协作开发的时候，mysql 作表变更还挺烦的，


---

## redis

redis 用的很多，一般是用来做排行榜，或是一些

---

# 总结

---

# 参考
[1] GeeksforGeeks. "Introduction of B+ Tree" ( https://www.geeksforgeeks.org/introduction-of-b-tree/ ). 