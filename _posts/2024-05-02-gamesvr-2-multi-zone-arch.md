---
layout: post
title: "游戏服务器工程实践三：分服分区游戏的常规架构"
date: 2024-05-02
last_modified_at: 2024-05-02
categories: [游戏后端]
tags: [gameserver]
---

* 目录  
{:toc}
<br/>



---

全区全服和分区分服这两大类游戏的服务器我都开发过，宏观架构上，分区分服要简单得多，需要水平扩容的地方不多。   

分区分服游戏范指那种登录注册后，有很多个区服可以选择，选择其中一个之后才能进入游戏的，并且各个区服的角色数据是不互通的（转服、合服、跨服在本质上也都是数据不互通的）。市面上大部分的游戏都是分区分服的。  

分区分服类型的游戏，其核心挑战是战斗逻辑、网络同步，但宏观架构也至关重要，这关系到：1、能不能撑得住上线后的疯狂导量；2、出问题之后能否快速定位。  

本文将主要介绍分区分服类型游戏的常规架构，以及如何保证它的高可用&容灾。  

---

# 1. 总体架构

## 1.1 架构图

以下是一个实际可用的服务器架构：      

<br/>
<div align="center">
<img src="https://antsmallant-blog-1251470010.cos.ap-guangzhou.myqcloud.com/media/blog/gamesvr-multi-zone-architecture.drawio.png"/>
</div>
<center>图1：分区分服游戏服务器总体架构</center>
<br/>

---

## 1.2 工作过程

以 “玩家登录并进入选中的区服” 为场景，简单说明一下工作过程:   

<br/>
<div align="center">
<img src="https://antsmallant-blog-1251470010.cos.ap-guangzhou.myqcloud.com/media/blog/gamesvr-multi-zone-cli-join-battle-seq.png"/>
</div>
<center>图2：玩家登录并进入选中的区服</center>
<br/>

用文字描述就是：  

1、客户端通过 sdksvr 完成 sdk 登录授权，成功获得一个 sdk token；    
2、客户端通过 sdksvr 获取区服列表；   
3、客户端选中一个区服请求进入，sdksvr 向该区服的 intfsvr（接口服务器）发起 “创角或登录” 请求，intfsvr 响应并返回一个 game token；  
4、客户端使用 game token 连接 gamesvr；   

---

# 2. 架构说明

以上架构图里展示的，需要支持水平扩容的就是 sdksvr 以及它对应的 PlatDB，这是平台级别的，所有的用户都先经过这里，再进入各自的区服，所以高峰的时候负载也特别重的，与全区全服类型的游戏一样。  

下面具体讲下架构的各个组成部分，包括它们的主要作用，以及如何做到水平扩容、高可用、容灾。    

---

## 2.1 网络负载层

---

## 2.2 游戏服务器层 

### 2.2.1 各服务器的作用

|服务器|作用|
|:--|:--|
|sdksvr|为玩家提供登录、注册、充值、版本更新、停服公告等功能；为外部厂商提供充值回调、推广回调等功能|
|managesvr|为运营人员提供后台管理功能，比如发公告，开新的区服，合服等等；为运营人员提供统计数据查看功能|
|intfsvr|区服中的接口服务器（interface server），一般实现为 http server，暴露区服的接口给 sdksvr 和 managesvr，比如创角，修改数据等|
|gamesvr|区服中的游戏服务器，提供所有的游戏功能，有时候实现上不止一个进程，但至少有一个是面向玩家连接的|

---

### 2.2.2 各服务器的特性

|服务器|面向|通讯协议|水平扩容|负载均衡|高可用|容灾|
|:--|:--|:--|:--|:--|:--|:--|
|sdksvr|玩家&外部厂商|http|支持，无状态web服务器|支持，由前置的的nginx集群提供负载均衡|支持，冗余部署即可|支持，无状态的，宕机不丢数据|
|managesvr|运营人员|http|支持，无状态web服务器|支持，但没必要，若需要可部署前置的nginx集群提供负载均衡|支持，冗余部署即可|支持，无状态的，宕机不丢数据|
|intfsvr|服务器间的接口|http|支持，但不需要，无状态web服务器|支持，但不需要|支持，但不需要|支持，无状态的，宕机不丢数据|
|gamesvr|玩家| (udp or tcp) + protobuf + 长连接|不支持|不支持|不支持|不支持，有状态的，cache了战斗状态，宕机会丢失整个场景数据|


---

## 2.3 数据层

---